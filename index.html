<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FOC Meter Data Collection</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const SUPABASE_URL = 'https://lzltmmfwwaqbkaovjpol.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6bHRtbWZ3d2FxYmthb3ZqcG9sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODc5OTYsImV4cCI6MjA4MTM2Mzk5Nn0.rYnsIiCTt7YuC4pfgaenpuz2DOUgYScwAVxCDc3jzsg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const MAX_ENTRIES = 25;

    const User = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
    );
    
    const Search = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    );

    const Save = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
      </svg>
    );

    const Download = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
      </svg>
    );

    const Trash2 = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    );

    const Loader = ({ className }) => (
      <svg className={className} fill="none" viewBox="0 0 24 24">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    );

    const RefreshCw = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );

    const AlertCircle = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const FOCDataEntry = () => {
      const [replacementOrders, setReplacementOrders] = useState([]);
      const [regularizationOrders, setRegularizationOrders] = useState([]);
      const [processedMeters, setProcessedMeters] = useState([]);
      const [currentMeterData, setCurrentMeterData] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [isSaving, setIsSaving] = useState(false);
      const [oldMeterNumber, setOldMeterNumber] = useState('');
      const [userId, setUserId] = useState('');
      const [userName, setUserName] = useState('');
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [activeTab, setActiveTab] = useState('replacement');

      useEffect(() => {
        const savedUserId = localStorage.getItem('foc_user_id');
        const savedUserName = localStorage.getItem('foc_user_name');
        
        if (savedUserId && savedUserName) {
          setUserId(savedUserId);
          setUserName(savedUserName);
          setIsLoggedIn(true);
        }
      }, []);

      useEffect(() => {
        if (isLoggedIn) {
          loadFromSupabase();
        }
      }, [isLoggedIn]);

      const handleLogin = () => {
        const name = prompt('Enter your name/FOC identifier:');
        if (name && name.trim()) {
          const trimmedName = name.trim();
          const generatedId = `foc_${trimmedName.toLowerCase().replace(/\s+/g, '_')}_${Date.now()}`;
          
          setUserId(generatedId);
          setUserName(trimmedName);
          setIsLoggedIn(true);
          
          localStorage.setItem('foc_user_id', generatedId);
          localStorage.setItem('foc_user_name', trimmedName);
        }
      };

      const handleLogout = () => {
        if (window.confirm('Are you sure you want to logout? Your unsaved work will remain in the system.')) {
          localStorage.removeItem('foc_user_id');
          localStorage.removeItem('foc_user_name');
          setUserId('');
          setUserName('');
          setIsLoggedIn(false);
          setProcessedMeters([]);
          setCurrentMeterData(null);
          clearForm();
        }
      };

      const loadFromSupabase = async () => {
        setIsLoading(true);
        try {
          let allReplacementData = [];
          let allRegularizationData = [];
          let from = 0;
          const batchSize = 1000;

          let hasMoreReplacement = true;
          while (hasMoreReplacement) {
            const { data: replacementData, error: replacementError } = await supabase
              .from('replacement_orders')
              .select('*')
              .order('uploaded_at', { ascending: false })
              .range(from, from + batchSize - 1);

            if (replacementError) throw replacementError;

            if (replacementData && replacementData.length > 0) {
              allReplacementData = [...allReplacementData, ...replacementData];
              from += batchSize;
              hasMoreReplacement = replacementData.length === batchSize;
            } else {
              hasMoreReplacement = false;
            }
          }

          from = 0;
          let hasMoreRegularization = true;
          while (hasMoreRegularization) {
            const { data: regularizationData, error: regularizationError } = await supabase
              .from('regularization_orders')
              .select('*')
              .order('uploaded_at', { ascending: false })
              .range(from, from + batchSize - 1);

            if (regularizationError) throw regularizationError;

            if (regularizationData && regularizationData.length > 0) {
              allRegularizationData = [...allRegularizationData, ...regularizationData];
              from += batchSize;
              hasMoreRegularization = regularizationData.length === batchSize;
            } else {
              hasMoreRegularization = false;
            }
          }

          setReplacementOrders(allReplacementData);
          setRegularizationOrders(allRegularizationData);
          
          const { data: metersData, error: metersError } = await supabase
            .from('processed_meters')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false });

          if (metersError) throw metersError;

          setProcessedMeters(metersData || []);
        } catch (error) {
          console.error('Error loading from Supabase:', error);
          alert('Error loading data from database. Please check your internet connection.');
        } finally {
          setIsLoading(false);
        }
      };

      const lookupMeter = () => {
        if (!oldMeterNumber.trim()) {
          alert('Please enter an old meter number');
          return;
        }

        const searchData = activeTab === 'replacement' ? replacementOrders : regularizationOrders;

        if (searchData.length === 0) {
          alert(`No ${activeTab} orders found. Please contact admin.`);
          return;
        }

        const meterData = searchData.find(row => {
          const oldMeter = row.old_meter_number;
          return oldMeter && oldMeter.toString().trim().toUpperCase() === oldMeterNumber.toUpperCase();
        });

        if (!meterData) {
          const partialMatch = searchData.find(row => {
            const oldMeter = row.old_meter_number;
            return oldMeter && oldMeter.toString().trim().toUpperCase().includes(oldMeterNumber.toUpperCase());
          });
          
          if (partialMatch) {
            setCurrentMeterData(partialMatch);
          } else {
            alert(`Meter "${oldMeterNumber}" not found in ${activeTab} orders.`);
          }
        } else {
          setCurrentMeterData(meterData);
        }
      };

      const addToDataset = async () => {
        if (!currentMeterData) {
          alert('Please lookup a meter first');
          return;
        }

        if (processedMeters.length >= MAX_ENTRIES) {
          alert(`You have reached the maximum limit of ${MAX_ENTRIES} entries. Please export your data and start fresh.`);
          return;
        }

        setIsSaving(true);

        try {
          const processedMeter = {
            user_id: userId,
            user_name: userName,
            order_data: currentMeterData,
            order_type: activeTab,
            created_at: new Date().toISOString()
          };

          const { data, error } = await supabase
            .from('processed_meters')
            .insert([processedMeter])
            .select();

          if (error) throw error;

          setProcessedMeters([data[0], ...processedMeters]);
          
          clearForm();
          alert(`Meter added successfully! (${processedMeters.length + 1}/${MAX_ENTRIES})`);
        } catch (error) {
          console.error('Error saving to Supabase:', error);
          alert(`Error saving data: ${error.message}`);
        } finally {
          setIsSaving(false);
        }
      };

      const clearForm = () => {
        setOldMeterNumber('');
        setCurrentMeterData(null);
      };

      const clearDataset = async () => {
        if (processedMeters.length === 0) {
          alert('Dataset is already empty');
          return;
        }
        
        if (window.confirm('Are you sure you want to clear the entire dataset? This will delete all data from the cloud.')) {
          try {
            const { data: userRecords, error: fetchError } = await supabase
              .from('processed_meters')
              .select('id')
              .eq('user_id', userId);

            if (fetchError) throw fetchError;

            if (userRecords && userRecords.length > 0) {
              const ids = userRecords.map(record => record.id);
              const { error: deleteError } = await supabase
                .from('processed_meters')
                .delete()
                .in('id', ids);

              if (deleteError) throw deleteError;
            }

            setProcessedMeters([]);
            alert('Dataset cleared successfully!');
          } catch (error) {
            console.error('Clear dataset error:', error);
            alert(`Error clearing dataset: ${error.message}`);
          }
        }
      };

      const exportExcel = (orderType) => {
        const metersToExport = processedMeters.filter(meter => meter.order_type === orderType);
        
        if (metersToExport.length === 0) {
          alert(`No ${orderType} data to export`);
          return;
        }

        let headers = [];
        
        if (orderType === 'replacement') {
          headers = [
            'SN', 'CMS REGION CODE', 'DISTRICT CODE', 'SERVICE ORDER CODE', 'SERVICE ORDER TYPE',
            'SERVICE POINT NUMBER', 'CUSTOMER NAME', 'CUSTOMER PHONE', 'EMAIL', 'GEOCODE',
            'TARIFF CODE', 'METER PHASE', 'OLD METER NUMBER', 'REQUESTED METER PHASE', 'NEW METER NUMBER',
            'FAULT TYPE', 'DIGITAL ADDRESS', 'ORDER STATUS', 'RETIREMENT CODE', 'PREPAID SYNC METHOD',
            'PREPAID SYNC STATUS', 'CONTRACTOR CODE', 'AGENT CODE', 'DATE CREATED', 'DATE ASSIGNED',
            'DATE ASSIGNED TO FOC', 'ASSIGNED TO FOC BY', 'DATE STARTED', 'DATE RESOLVED', 'DATE APPROVED',
            'APPROVED BY', 'DATE COMPLETED', 'PRESET AMOUNT', 'Batch ID', 'Org ID',
            'COSEM Logical Device Name', 'MFG Serial Number', 'Customer Serial Number', 'Manufacturer', 'Model Type',
            'IP Address', 'GPRS Module Serial Number', 'Firmware Type', 'Firmware Version', 'LLS Secret',
            'HLS Secret', 'Authentication', 'Encryption Key', 'MAC', 'Badge ID',
            'BLANK', 'RE-ROUTING TYPE', 'UIU RELEASED', 'Meter Enclosures - Three Phase', 'Meter Enclosures - Single Phase',
            'Soft Al Binding Wire', '9m Wooden Pole', 'Stay equipment c/w Rod & plate, Bow, 2No. Brackets & 2No. Thimbles and M16 * 40mm bolts and nuts',
            'LV Stay Insulator', '50/25 bolted type Aluminium tap off clamp', 'Green/Blue Meter Seals', 'Tower Clips',
            'Wooden Stay block', 'Stay wire-7/4 SWG', 'LV Shackle Insulator- Porcelain (76mm height)', 'D Iron C/W Pin (99mm *120mm *6mm) Large',
            'Coachscrew Insulator (Wonpiece)', 'LV Insulating Tape', '50sq.mm Al bare conductor', '120 sq.mm Al bare conductor',
            'Bolt & Nut (m16 x 260)', '120/25 bolted type Aluminium tap off clamp', '16CU/25AL bi-metal ferrule compression type',
            '8m Wooden Pole', '2*25sq.mm PVC Al Cable', 'UIU Cable', '7mm Clip', 'Breaker',
            '35Cu/25Al Bi-Metallic tap off clamp', '70Cu/25Al Bi-Metallic tap off clamp', 'Undersized Cable(s)',
            'SL 7000 DTM with Enclosure, Rogoskwi Coils and Voltage Taps', 'I-Smart with Enclosure', 'Flexible Tube (Bury cables)',
            'Bolt, Nut and Washers', 'Bi-metal Lug (35sqmm)', 'Cable belt (Large)', '2x35sqmm AL PVC Cable',
            'Enclosure strap', 'Bandit Tape', 'Hexing meter complete with Metering cubicle'
          ];
        } else {
          headers = [
            'SN', 'CMS REGION CODE', 'DISTRICT CODE', 'SERVICE ORDER CODE', 'SERVICE ORDER TYPE', 'INSTALLATION TYPE',
            'SERVICE POINT NUMBER', 'CUSTOMER NAME', 'CUSTOMER PHONE', 'EMAIL', 'GEOCODE',
            'TARIFF CODE', 'METER PHASE', 'OLD METER NUMBER', 'DIGITAL ADDRESS', 'ORDER STATUS',
            'PREPAID SYNC METHOD', 'PREPAID SYNC STATUS', 'CONTRACTOR CODE', 'AGENT CODE',
            'DATE CREATED', 'DATE ASSIGNED', 'DATE ASSIGNED TO FOC', 'ASSIGNED TO FOC BY',
            'DATE STARTED', 'DATE RESOLVED', 'DATE APPROVED', 'APPROVED BY', 'DATE COMPLETED',
            'PRESET AMOUNT', 'Batch ID', 'Org ID', 'COSEM Logical Device Name', 'MFG Serial Number',
            'Customer Serial Number', 'Manufacturer', 'Model Type', 'IP Address', 'GPRS Module Serial Number',
            'Firmware Type', 'Firmware Version', 'LLS Secret', 'HLS Secret', 'Authentication',
            'Encryption Key', 'MAC', 'Badge ID', 'BLANK', 'RE-ROUTING TYPE', 'UIU RELEASED',
            'Meter Enclosures - Single Phase', 'Meter Enclosures - Three Phase', 'Coachscrew Insulator (Wonpiece)',
            'LV Insulating Tape', 'Tower Clips', '50sq.mm Al bare conductor', '120 sq.mm Al bare conductor',
            '9m Wooden Pole', 'Wooden Stay block', 'Stay wire-7/4 SWG',
            'Stay equipment c/w Rod & plate, Bow, 2No. Brackets & 2No. Thimbles and M16 * 40mm bolts and nuts',
            'LV Stay Insulator', '50/25 bolted type Aluminium tap off clamp', 'Bolt & Nut (m16 x 260)',
            'LV Shackle Insulator- Porcelain (76mm height)', 'Green/Blue Meter Seals', 'Soft Al Binding Wire',
            '120/25 bolted type Aluminium tap off clamp', 'D Iron C/W Pin (99mm *120mm *6mm) Large',
            '16CU/25AL bi-metal ferrule compression type', '8m Wooden Pole', '2*25sq.mm PVC Al Cable',
            'UIU Cable', '7mm Clip', 'Breaker', '35Cu/25Al Bi-Metallic tap off clamp',
            '70Cu/25Al Bi-Metallic tap off clamp', 'Undersized Cable(s)',
            'SL 7000 DTM with Enclosure, Rogoskwi Coils and Voltage Taps', 'I-Smart with Enclosure',
            'Flexible Tube (Bury cables)', 'Bolt, Nut and Washers', 'Bi-metal Lug (35sqmm)',
            'Cable belt (Large)', '2x35sqmm AL PVC Cable', 'Enclosure strap', 'Bandit Tape',
            'Hexing meter complete with Metering cubicle'
          ];
        }

        const data = [headers];
        
        metersToExport.forEach(meter => {
          const o = meter.order_data || {};
          
          if (orderType === 'replacement') {
            data.push([
              o.sn || '', o.cms_region_code || '', o.district_code || '', o.service_order_code || '',
              o.service_order_type || '', o.service_point_number || '', o.customer_name || '',
              o.customer_phone || '', o.email || '', o.geocode || '', o.tariff_code || '',
              o.meter_phase || '', o.old_meter_number || '', o.requested_meter_phase || '',
              o.new_meter_number || '', o.fault_type || '', o.digital_address || '', o.order_status || '',
              o.retirement_code || '', o.prepaid_sync_method || '', o.prepaid_sync_status || '',
              o.contractor_code || '', o.agent_code || '', o.date_created || '', o.date_assigned || '',
              o.date_assigned_to_foc || '', o.assigned_to_foc_by || '', o.date_started || '',
              o.date_resolved || '', o.date_approved || '', o.approved_by || '', o.date_completed || '',
              o.preset_amount || '', o.batch_id || '', o.org_id || '', o.cosem_logical_device_name || '',
              o.mfg_serial_number || '', o.customer_serial_number || '', o.manufacturer || '',
              o.model_type || '', o.ip_address || '', o.gprs_module_serial_number || '',
              o.firmware_type || '', o.firmware_version || '', o.lls_secret || '', o.hls_secret || '',
              o.authentication || '', o.encryption_key || '', o.mac || '', o.badge_id || '',
              o.blank || '', o.re_routing_type || '', o.uiu_released || '',
              o.meter_enclosures_three_phase || '', o.meter_enclosures_single_phase || '',
              o.soft_al_binding_wire || '', o.wooden_pole_9m || '', o.stay_equipment || '',
              o.lv_stay_insulator || '', o.aluminium_tap_off_clamp_50_25 || '', o.meter_seals || '',
              o.tower_clips || '', o.wooden_stay_block || '', o.stay_wire || '',
              o.lv_shackle_insulator || '', o.d_iron || '', o.coachscrew_insulator || '',
              o.lv_insulating_tape || '', o.al_bare_conductor_50 || '', o.al_bare_conductor_120 || '',
              o.bolt_nut || '', o.aluminium_tap_off_clamp_120_25 || '', o.bi_metal_ferrule || '',
              o.wooden_pole_8m || '', o.pvc_al_cable_2x25 || '', o.uiu_cable || '', o.clip_7mm || '',
              o.breaker || '', o.bi_metallic_tap_off_clamp_35 || '', o.bi_metallic_tap_off_clamp_70 || '',
              o.undersized_cables || '', o.sl_7000_dtm || '', o.i_smart || '', o.flexible_tube || '',
              o.bolt_nut_washers || '', o.bi_metal_lug || '', o.cable_belt || '', o.pvc_al_cable_2x35 || '',
              o.enclosure_strap || '', o.bandit_tape || '', o.hexing_meter || ''
            ]);
          } else {
            data.push([
              o.sn || '', o.cms_region_code || '', o.district_code || '', o.service_order_code || '',
              o.service_order_type || '', o.installation_type || '', o.service_point_number || '',
              o.customer_name || '', o.customer_phone || '', o.email || '', o.geocode || '',
              o.tariff_code || '', o.meter_phase || '', o.old_meter_number || '', o.digital_address || '',
              o.order_status || '', o.prepaid_sync_method || '', o.prepaid_sync_status || '',
              o.contractor_code || '', o.agent_code || '', o.date_created || '', o.date_assigned || '',
              o.date_assigned_to_foc || '', o.assigned_to_foc_by || '', o.date_started || '',
              o.date_resolved || '', o.date_approved || '', o.approved_by || '', o.date_completed || '',
              o.preset_amount || '', o.batch_id || '', o.org_id || '', o.cosem_logical_device_name || '',
              o.mfg_serial_number || '', o.customer_serial_number || '', o.manufacturer || '',
              o.model_type || '', o.ip_address || '', o.gprs_module_serial_number || '',
              o.firmware_type || '', o.firmware_version || '', o.lls_secret || '', o.hls_secret || '',
              o.authentication || '', o.encryption_key || '', o.mac || '', o.badge_id || '',
              o.blank || '', o.re_routing_type || '', o.uiu_released || '',
              o.meter_enclosures_single_phase || '', o.meter_enclosures_three_phase || '',
              o.coachscrew_insulator || '', o.lv_insulating_tape || '', o.tower_clips || '',
              o.al_bare_conductor_50 || '', o.al_bare_conductor_120 || '', o.wooden_pole_9m || '',
              o.wooden_stay_block || '', o.stay_wire || '', o.stay_equipment || '',
              o.lv_stay_insulator || '', o.aluminium_tap_off_clamp_50_25 || '', o.bolt_nut || '',
              o.lv_shackle_insulator || '', o.meter_seals || '', o.soft_al_binding_wire || '',
              o.aluminium_tap_off_clamp_120_25 || '', o.d_iron || '', o.bi_metal_ferrule || '',
              o.wooden_pole_8m || '', o.pvc_al_cable_2x25 || '', o.uiu_cable || '', o.clip_7mm || '',
              o.breaker || '', o.bi_metallic_tap_off_clamp_35 || '', o.bi_metallic_tap_off_clamp_70 || '',
              o.undersized_cables || '', o.sl_7000_dtm || '', o.i_smart || '', o.flexible_tube || '',
              o.bolt_nut_washers || '', o.bi_metal_lug || '', o.cable_belt || '',
              o.pvc_al_cable_2x35 || '', o.enclosure_strap || '', o.bandit_tape || '',
              o.hexing_meter || ''
            ]);
          }
        });

        const worksheet = XLSX.utils.aoa_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, orderType.charAt(0).toUpperCase() + orderType.slice(1));
        XLSX.writeFile(workbook, `FOC_${orderType.charAt(0).toUpperCase() + orderType.slice(1)}_Data_${userName}_${new Date().toISOString().split('T')[0]}.xlsx`);
      };

      if (!isLoggedIn) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg border border-gray-200 shadow-sm p-8 max-w-md w-full">
              <div className="text-center mb-8">
                <div className="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
                  <User className="w-8 h-8 text-blue-600" />
                </div>
                <h1 className="text-2xl font-semibold text-gray-800 mb-2">FOC Login</h1>
                <p className="text-sm text-gray-600">Enter your name to start recording meter data</p>
              </div>
              
              <button
                onClick={handleLogin}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-all text-base"
              >
                Login / Start Session
              </button>
              
              <div className="mt-6 text-center text-xs text-gray-500">
                <p>Your data will be saved separately from other FOCs</p>
              </div>
            </div>
          </div>
        );
      }

      if (isLoading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <Loader className="w-12 h-12 text-blue-600 mx-auto mb-4 animate-spin" />
              <p className="text-gray-600">Loading data from database...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
              <div className="flex justify-between items-center">
                <div>
                  <h1 className="text-2xl font-bold text-gray-800">FOC Meter Data Collection</h1>
                  <p className="text-sm text-gray-600">Logged in as: <span className="font-semibold">{userName}</span></p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={loadFromSupabase}
                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <RefreshCw className="w-4 h-4" />
                    Refresh
                  </button>
                  <button
                    onClick={handleLogout}
                    className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                  >
                    Logout
                  </button>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 className="text-xl font-semibold text-gray-800 mb-4">Lookup Meter</h2>
                
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => setActiveTab('replacement')}
                    className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                      activeTab === 'replacement'
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Replacement
                  </button>
                  <button
                    onClick={() => setActiveTab('regularization')}
                    className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                      activeTab === 'regularization'
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Regularization
                  </button>
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Old Meter Number
                  </label>
                  <input
                    type="text"
                    value={oldMeterNumber}
                    onChange={(e) => setOldMeterNumber(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && lookupMeter()}
                    placeholder="Enter old meter number"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                <button
                  onClick={lookupMeter}
                  className="w-full flex items-center justify-center gap-2 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors mb-4"
                >
                  <Search className="w-4 h-4" />
                  Search
                </button>

                {currentMeterData && (
                  <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 className="font-semibold text-gray-800 mb-2">Meter Found</h3>
                    <div className="space-y-2 text-sm">
                      <p><span className="font-medium">Service Order:</span> {currentMeterData.service_order_code}</p>
                      <p><span className="font-medium">Customer:</span> {currentMeterData.customer_name}</p>
                      <p><span className="font-medium">Old Meter:</span> {currentMeterData.old_meter_number}</p>
                      {currentMeterData.new_meter_number && (
                        <p><span className="font-medium">New Meter:</span> {currentMeterData.new_meter_number}</p>
                      )}
                      <p><span className="font-medium">Phase:</span> {currentMeterData.meter_phase}</p>
                      <p><span className="font-medium">Type:</span> {activeTab}</p>
                    </div>
                  </div>
                )}

                <button
                  onClick={addToDataset}
                  disabled={!currentMeterData || isSaving}
                  className="w-full flex items-center justify-center gap-2 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                >
                  {isSaving ? (
                    <>
                      <Loader className="w-4 h-4 animate-spin" />
                      Saving...
                    </>
                  ) : (
                    <>
                      <Save className="w-4 h-4" />
                      Add to Dataset ({processedMeters.length}/{MAX_ENTRIES})
                    </>
                  )}
                </button>
              </div>

              <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-semibold text-gray-800">Processed Meters</h2>
                  <span className="text-sm text-gray-600">{processedMeters.length}/{MAX_ENTRIES}</span>
                </div>

                {processedMeters.length >= MAX_ENTRIES && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 flex items-start gap-2">
                    <AlertCircle className="w-5 h-5 text-yellow-600 flex-shrink-0" />
                    <p className="text-sm text-yellow-800">
                      Maximum limit reached. Please export and clear dataset.
                    </p>
                  </div>
                )}

                <div className="space-y-2 mb-4">
                  <button
                    onClick={() => exportExcel('replacement')}
                    disabled={processedMeters.filter(m => m.order_type === 'replacement').length === 0}
                    className="w-full flex items-center justify-center gap-2 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                  >
                    <Download className="w-4 h-4" />
                    Export Replacement ({processedMeters.filter(m => m.order_type === 'replacement').length})
                  </button>
                  <button
                    onClick={() => exportExcel('regularization')}
                    disabled={processedMeters.filter(m => m.order_type === 'regularization').length === 0}
                    className="w-full flex items-center justify-center gap-2 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                  >
                    <Download className="w-4 h-4" />
                    Export Regularization ({processedMeters.filter(m => m.order_type === 'regularization').length})
                  </button>
                  <button
                    onClick={clearDataset}
                    disabled={processedMeters.length === 0}
                    className="w-full flex items-center justify-center gap-2 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                  >
                    <Trash2 className="w-4 h-4" />
                    Clear Dataset
                  </button>
                </div>

                <div className="border border-gray-200 rounded-lg max-h-96 overflow-y-auto">
                  {processedMeters.length === 0 ? (
                    <div className="p-8 text-center text-gray-500">
                      <p>No meters added yet</p>
                    </div>
                  ) : (
                    <div>
                      {processedMeters.map((meter) => (
                        <div key={meter.id} className="p-3 border-b border-gray-200 hover:bg-gray-50">
                          <div className="flex justify-between items-start">
                            <div>
                              <p className="font-medium text-gray-800">{meter.order_data.old_meter_number}</p>
                              <p className="text-sm text-gray-600">{meter.order_data.customer_name}</p>
                              <p className="text-xs text-gray-500">{meter.order_type}</p>
                            </div>
                            <span className="text-xs text-gray-500">
                              {new Date(meter.created_at).toLocaleDateString()}
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
              <h3 className="font-semibold text-blue-900 mb-2">Database Info</h3>
              <div className="text-sm text-blue-800">
                <p>Replacement Orders: {replacementOrders.length}</p>
                <p>Regularization Orders: {regularizationOrders.length}</p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<FOCDataEntry />, document.getElementById('root'));
  </script>
</body>
</html>
